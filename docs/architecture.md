# pm-mem 系统架构

## 概述

pm-mem 是一个基于 ReMem（Self-Evolving Memory for LLM Agents）方法论的 LLM 长短记忆管理系统。系统实现了自演化记忆管理能力，支持记忆的动态编辑、运行时优化和智能检索。

## 核心架构图

```
┌─────────────────────────────────────────────────────────┐
│                     ReMem Agent                          │
├─────────────┬──────────────┬──────────────┬─────────────┤
│   Think     │    Refine    │     Act      │  状态机     │
│  (内部推理) │  (记忆编辑)   │  (对外行动)  │             │
└─────────────┴──────────────┴──────────────┴─────────────┘
        │            │             │              │
        ▼            ▼             ▼              ▼
┌─────────────────────────────────────────────────────────┐
│                   记忆管理系统                           │
├─────────────┬──────────────┬──────────────┬─────────────┤
│  记忆检索   │  记忆编辑     │  记忆持久化  │  记忆库     │
│  (Retrieve) │  (Editor)    │  (Persistence)│ (MemoryBank)│
└─────────────┴──────────────┴──────────────┴─────────────┘
        │            │             │              │
        ▼            ▼             ▼              ▼
┌─────────────────────────────────────────────────────────┐
│                    LLM 集成层                           │
├─────────────┬──────────────┬──────────────┬─────────────┤
│ DeepSeek API│  模拟LLM     │ 抽象接口     │  提示词系统 │
│             │  (MockLLM)   │  (Interface) │  (Prompts)  │
└─────────────┴──────────────┴──────────────┴─────────────┘
        │            │             │              │
        ▼            ▼             ▼              ▼
┌─────────────────────────────────────────────────────────┐
│                    支撑系统                             │
├─────────────┬──────────────┬──────────────┬─────────────┤
│  配置管理   │  日志监控    │  验证工具    │  测试框架   │
│  (Config)   │  (Logging)   │  (Validators)│  (Tests)    │
└─────────────┴──────────────┴──────────────┴─────────────┘
```

## 模块详细说明

### 1. ReMem Agent (`src/agent/`)

**核心组件**：实现 ReMem 方法论的主循环

- `remem_agent.py` - ReMem Agent 主类，实现 Think/Refine/Act 状态机
- `state_machine.py` - 状态机实现，管理状态转移和迭代控制
- `prompts.py` - 提示词模板系统，管理 Think/Refine/Act 的标准提示词

**职责**：
- 管理任务执行的主循环
- 协调各模块的协作
- 实现最大迭代次数限制和强制终止机制
- 维护执行轨迹和状态历史

### 2. 记忆管理系统 (`src/memory/`)

**核心组件**：管理记忆的存储、检索、编辑和持久化

- `entry.py` - 记忆条目 (`MemoryEntry`) 数据结构定义
- `bank.py` - 记忆库 (`MemoryBank`) 管理类
- `editor.py` - 记忆编辑模块 (`RefineEditor`)，支持 DELETE/ADD/MERGE/RELABEL
- `persistence.py` - 持久化存储 (`MemoryPersistence`)，基于 JSON 文件

**职责**：
- 存储和管理记忆条目
- 基于 LLM 的文本相关性检索
- 执行记忆编辑操作
- 提供序列化和持久化功能

### 3. LLM 集成层 (`src/llm/`)

**核心组件**：提供统一的 LLM 调用接口

- `llm_interface.py` - LLM 抽象接口定义
- `deepseek_client.py` - DeepSeek API 客户端实现
- `mock_llm.py` - 模拟 LLM，用于测试和开发

**职责**：
- 提供统一的 LLM 调用接口
- 实现 API 密钥管理和错误处理
- 支持不同 LLM 提供商的切换

### 4. 支撑系统 (`src/config/`, `src/utils/`)

**配置管理** (`src/config/`)：
- `config_manager.py` - 配置管理器，支持 YAML/JSON 配置
- `defaults.yaml` - 默认配置

**工具模块** (`src/utils/`)：
- `logger.py` - 结构化日志记录和性能监控
- `validators.py` - 验证工具函数

### 5. 测试系统 (`tests/`)

- `unit/` - 单元测试
  - `test_memory.py` - 记忆模块测试
  - `test_agent.py` - Agent 模块测试
  - `test_llm.py` - LLM 模块测试
- `integration/` - 集成测试
  - `test_remem_workflow.py` - 完整工作流程测试

## 数据流

### 正向工作流（任务执行）

```
1. 接收任务输入 (x_t)
2. 从记忆库检索相关记忆 (Retrieve)
3. 选择动作 (Think/Refine/Act)
4. 执行选定动作：
   - Think: 内部推理，更新轨迹
   - Refine: 编辑记忆库，更新轨迹
   - Act: 输出结果，添加新记忆，结束循环
5. 重复 2-4 直到选择 Act 或达到最大迭代次数
6. 持久化记忆库
```

### 反向工作流（学习与演化）

```
1. 环境反馈 (f_t) 被整合为新记忆
2. 新记忆根据相关性被检索和使用
3. 通过 Refine 操作优化记忆库：
   - 删除冗余或错误记忆
   - 合并相似记忆
   - 重新分类记忆标签
4. 定期清理低价值记忆
```

## 关键技术决策

### 1. 检索方案
- **方案**：LLM 驱动的文本相关性排序
- **理由**：符合技术约束（禁止使用向量数据库和 embedding）
- **优点**：无需额外基础设施，直接利用 LLM 的理解能力
- **缺点**：随着记忆库规模增长，效率可能下降

### 2. 存储方案
- **方案**：JSON 文件存储
- **理由**：简单可靠，易于调试和迁移
- **优点**：无需数据库服务，支持版本控制
- **缺点**：大规模记忆库性能有限

### 3. 编辑语法
- **方案**：结构化命令解析（DELETE/ADD/MERGE/RELABEL）
- **理由**：确保编辑操作的可解析性和可靠性
- **优点**：明确的语法，易于验证和调试
- **缺点**：需要严格的语法检查和错误处理

### 4. 状态机设计
- **方案**：MDP 形式的状态机
- **理由**：符合 ReMem 论文的形式化定义
- **优点**：清晰的状態转移逻辑，便于扩展和维护
- **缺点**：增加了一定的复杂性

## 扩展性设计

### 1. 模块化设计
每个模块职责单一，接口清晰，便于：
- 替换实现（如更换 LLM 提供商）
- 扩展功能（如添加新的记忆编辑操作）
- 独立测试和调试

### 2. 配置驱动
系统行为通过配置文件控制，支持：
- 不同环境配置（开发/测试/生产）
- 动态参数调整
- 热重载配置

### 3. 插件化架构
关键接口设计为可扩展：
- LLM 接口支持多种实现
- 记忆检索支持不同算法
- 持久化支持不同存储后端

## 性能考虑

### 1. 检索优化
- 实现 Top-k 检索，避免全量排序
- 支持检索结果缓存
- 可配置的检索参数

### 2. 记忆库管理
- 最大容量限制
- 自动清理机制
- 懒加载和分页支持

### 3. 资源管理
- API 调用频率限制
- 超时和重试机制
- 内存使用监控

## 安全考虑

### 1. 输入验证
- 任务输入验证
- Refine 命令语法验证
- 文件路径安全验证

### 2. 配置安全
- API 密钥通过环境变量管理
- 敏感配置加密支持
- 配置文件权限控制

### 3. 操作审计
- 关键操作日志记录
- 性能指标收集
- 异常监控和告警